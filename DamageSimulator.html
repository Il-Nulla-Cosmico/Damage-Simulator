<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulatore Danno Frutti</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; text-align: center; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
        h2 { color: #2c3e50; }
        input { width: 80%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        button { background-color: #27ae60; color: white; border: none; padding: 12px 20px; font-size: 16px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px; }
        button:hover { background-color: #219150; }
        #risultato { margin-top: 20px; text-align: left; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #eee; }
        .total-box { background: #e8f8f5; padding: 10px; border-radius: 5px; margin-top: 15px; text-align: center; font-weight: bold; color: #16a085; }
        
        /* STILE PER LA FIRMA */
        .footer { 
            margin-top: 30px; 
            font-size: 12px; 
            color: #95a5a6; 
            border-top: 1px solid #ecf0f1; 
            padding-top: 15px; 
            font-style: italic;
        }
    </style>
</head>
<body>

<div class="card">
    <h2>üçé Simulatore Danno</h2>
    
    <label>Numero Frutti:</label>
    <input type="number" id="nFrutti" value="100">
    
    <label>Target Danno (%):</label>
    <input type="number" id="targetPerc" value="22">
    
    <button onclick="calcola()">Calcola Distribuzione</button>

    <div id="risultato"></div>

    <div class="footer">
        Sviluppato da <b>BattleHorse</b>
    </div>

</div>

<script>
    function calcola() {
        const nFrutti = parseInt(document.getElementById('nFrutti').value);
        const targetPerc = parseFloat(document.getElementById('targetPerc').value);
        
        if (isNaN(nFrutti) || isNaN(targetPerc) || targetPerc < 0 || targetPerc > 100) {
            alert("Inserisci numeri validi (0-100 per la %)");
            return;
        }

        const classi = [0, 30, 60, 80, 100];
        let weights = [];
        let maxClasse = 100;

        // --- 1. LOGICA DEI PESI ---
        if (targetPerc <= 30) {
            weights = [0.50, 0.40, 0.10, 0, 0]; 
            maxClasse = 60;
        } else if (targetPerc <= 50) {
            weights = [0.20, 0.35, 0.30, 0.10, 0.05]; 
            maxClasse = 100;
        } else {
            weights = [0.05, 0.10, 0.20, 0.30, 0.35]; 
            maxClasse = 100;
        }

        function weightedRandom() {
            let sum = 0;
            let r = Math.random();
            for (let i = 0; i < weights.length; i++) {
                sum += weights[i];
                if (r <= sum) return classi[i];
            }
            return classi[0];
        }

        // --- 2. GENERAZIONE ---
        let frutti = [];
        for(let i=0; i<nFrutti; i++) {
            frutti.push(weightedRandom());
        }

        // --- 3. AGGIUSTAMENTO ---
        let currentScore = frutti.reduce((a, b) => a + b, 0);
        let targetScore = nFrutti * targetPerc;
        let iter = 0;
        let maxIter = nFrutti * 50;

        while (currentScore !== targetScore && iter < maxIter) {
            let diff = targetScore - currentScore;

            if (diff > 0) {
                let idxCandidati = frutti.map((val, idx) => val < maxClasse ? idx : -1).filter(idx => idx !== -1);
                if (idxCandidati.length > 0) {
                    let idx = idxCandidati[Math.floor(Math.random() * idxCandidati.length)];
                    let valAttuale = frutti[idx];

                    if (targetPerc <= 50 && valAttuale === 80) {
                         if (Math.random() > 0.7) frutti[idx] = 100; 
                    } else {
                        let nextClass = classi.find(c => c > valAttuale);
                        if (nextClass !== undefined) frutti[idx] = nextClass;
                    }
                }
            } else {
                let idxCandidati = frutti.map((val, idx) => val > 0 ? idx : -1).filter(idx => idx !== -1);
                if (idxCandidati.length > 0) {
                    let idx = idxCandidati[Math.floor(Math.random() * idxCandidati.length)];
                    let valAttuale = frutti[idx];
                    let prevClass = [...classi].reverse().find(c => c < valAttuale);
                    if (prevClass !== undefined) frutti[idx] = prevClass;
                }
            }
            currentScore = frutti.reduce((a, b) => a + b, 0);
            iter++;
        }

        // --- 4. OUTPUT ---
        let counts = {0:0, 30:0, 60:0, 80:0, 100:0};
        frutti.forEach(x => counts[x]++);
        let dannoReale = currentScore / nFrutti;

        let html = `<table><tr><th>Classe</th><th>N. Frutti</th><th>Prodotto</th></tr>`;
        classi.forEach(c => {
            if (counts[c] > 0 || c <= maxClasse) {
                html += `<tr><td>${c}%</td><td><b>${counts[c]}</b></td><td>${counts[c] * c}</td></tr>`;
            }
        });
        html += `</table>`;
        html += `<div class="total-box">Danno Finale Ottenuto: ${dannoReale.toFixed(2)}%</div>`;

        document.getElementById('risultato').innerHTML = html;
    }
</script>

</body>
</html>