<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulatore Danno BattleHorse</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 10px; background-color: #f0f2f5; text-align: center; color: #333; }
        
        /* Contenitore principale */
        .container { max-width: 1000px; margin: 0 auto; }
        
        /* Card Input */
        .input-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        h2 { color: #2c3e50; margin-bottom: 20px; }
        
        .input-group { margin-bottom: 15px; text-align: left; display: inline-block; width: 100%; max-width: 400px;}
        label { font-weight: bold; font-size: 14px; color: #555; display: block; margin-bottom: 5px; }
        input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        
        /* Griglia per le classi personalizzabili */
        .classes-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-bottom: 15px; }
        .class-input input { text-align: center; font-weight: bold; color: #e67e22; }

        button { background-color: #27ae60; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; width: 100%; max-width: 400px; transition: background 0.3s; box-shadow: 0 4px 6px rgba(39, 174, 96, 0.3); }
        button:hover { background-color: #219150; transform: translateY(-2px); }

        /* Layout Risultati */
        .results-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .scenario-card { 
            background: white; 
            flex: 1; 
            min-width: 300px; 
            padding: 15px; 
            border-radius: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            border-top: 5px solid #bdc3c7;
            display: flex;
            flex-direction: column;
        }
        
        .scenario-a { border-top-color: #f1c40f; } 
        .scenario-b { border-top-color: #e67e22; } 
        .scenario-c { border-top-color: #c0392b; } 

        h3 { font-size: 18px; margin-top: 0; color: #444; }
        .scenario-desc { font-size: 12px; color: #777; margin-bottom: 10px; font-style: italic; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; margin-bottom: auto; }
        th, td { border-bottom: 1px solid #eee; padding: 6px 4px; text-align: center; }
        th { background-color: #f8f9fa; color: #666; font-size: 12px; text-transform: uppercase; }
        
        /* Stile riga totali */
        .row-total { background-color: #f4f4f4; border-top: 2px solid #ddd; font-weight: bold; color: #2c3e50; }
        
        .total-box { margin-top: 15px; padding: 10px; background: #e8f8f5; border-radius: 6px; font-weight: bold; color: #16a085; font-size: 16px; border: 1px solid #a3e4d7; }
        .warning-box { margin-top: 5px; font-size: 11px; color: #e74c3c; display: none; }

        /* Footer */
        .footer { margin-top: 40px; font-size: 14px; color: #7f8c8d; border-top: 1px solid #ddd; padding-top: 15px; font-family: monospace; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="input-card">
        <h2>üìä Weighted average damage % simulator</h2>
        
        <div class="input-group">
            <label>1. Total number of damaged objects:</label>
            <div class="classes-grid">
                <div class="class-input"><input type="number" id="c1" value="0"></div>
                <div class="class-input"><input type="number" id="c2" value="30"></div>
                <div class="class-input"><input type="number" id="c3" value="60"></div>
                <div class="class-input"><input type="number" id="c4" value="80"></div>
                <div class="class-input"><input type="number" id="c5" value="100"></div>
            </div>
        </div>

        <div class="input-group">
            <label>2. Damage classes:</label>
            <input type="number" id="nFrutti" value="100">
        </div>
        
        <div class="input-group">
            <label>3. Target average damage (%):</label>
            <input type="number" id="targetPerc" value="25">
        </div>
        
        <br>
        <button onclick="lanciaSimulazione()">Generate scenarios</button>
    </div>

    <div class="results-container" id="outputArea" style="display:none;">
        
        <div class="scenario-card scenario-a">
            <h3>Scenario A</h3>
            <div class="scenario-desc">Solo prime 3 classi</div>
            <div id="resA"></div>
        </div>

        <div class="scenario-card scenario-b">
            <h3>Scenario B</h3>
            <div class="scenario-desc">Solo prime 4 classi</div>
            <div id="resB"></div>
        </div>

        <div class="scenario-card scenario-c">
            <h3>Scenario C</h3>
            <div class="scenario-desc">Tutte le classi</div>
            <div id="resC"></div>
        </div>

    </div>

    <div class="footer">
        Sviluppato da <b>BattleHorse</b> üêé
    </div>

</div>

<script>
    function lanciaSimulazione() {
        const nFrutti = parseInt(document.getElementById('nFrutti').value);
        const targetPerc = parseFloat(document.getElementById('targetPerc').value);
        
        const c1 = parseInt(document.getElementById('c1').value);
        const c2 = parseInt(document.getElementById('c2').value);
        const c3 = parseInt(document.getElementById('c3').value);
        const c4 = parseInt(document.getElementById('c4').value);
        const c5 = parseInt(document.getElementById('c5').value);
        const classiBase = [c1, c2, c3, c4, c5];

        if (isNaN(nFrutti) || isNaN(targetPerc)) { alert("Inserisci numeri validi!"); return; }

        document.getElementById('outputArea').style.display = "flex";

        eseguiCalcolo(nFrutti, targetPerc, classiBase, 2, 'resA');
        eseguiCalcolo(nFrutti, targetPerc, classiBase, 3, 'resB');
        eseguiCalcolo(nFrutti, targetPerc, classiBase, 4, 'resC');
    }

    function eseguiCalcolo(nFrutti, targetPerc, classiFull, maxIndex, elementId) {
        const classiAmmesse = classiFull.slice(0, maxIndex + 1);
        const maxValorePossibile = classiFull[maxIndex];

        let weights = [];
        if (maxIndex === 2) { 
            weights = [0.5, 0.4, 0.1]; 
        } else if (maxIndex === 3) {
            weights = [0.3, 0.4, 0.2, 0.1];
        } else {
            if (targetPerc <= 30) weights = [0.5, 0.4, 0.1, 0, 0];
            else if (targetPerc <= 50) weights = [0.2, 0.35, 0.3, 0.1, 0.05];
            else weights = [0.05, 0.10, 0.20, 0.30, 0.35];
        }

        function weightedRandom() {
            let sum = 0;
            let r = Math.random();
            let totalWeight = weights.reduce((a,b)=>a+b, 0);
            for (let i = 0; i < weights.length; i++) {
                sum += (weights[i] / totalWeight);
                if (r <= sum) return classiAmmesse[i];
            }
            return classiAmmesse[0];
        }

        let frutti = [];
        for(let i=0; i<nFrutti; i++) frutti.push(weightedRandom());

        let currentScore = frutti.reduce((a, b) => a + b, 0);
        let targetScore = nFrutti * targetPerc;
        let iter = 0;
        let maxIter = nFrutti * 200;

        while (Math.abs(currentScore - targetScore) > 0.01 && iter < maxIter) {
            let diff = targetScore - currentScore;

            if (diff > 0) {
                let candidati = frutti.map((val, idx) => val < maxValorePossibile ? idx : -1).filter(i => i !== -1);
                if (candidati.length === 0) break;
                let idx = candidati[Math.floor(Math.random() * candidati.length)];
                let valAttuale = frutti[idx];
                let nextClass = classiAmmesse.find(c => c > valAttuale);
                if (nextClass !== undefined) frutti[idx] = nextClass;
            } else {
                let candidati = frutti.map((val, idx) => val > classiAmmesse[0] ? idx : -1).filter(i => i !== -1);
                if (candidati.length === 0) break;
                let idx = candidati[Math.floor(Math.random() * candidati.length)];
                let valAttuale = frutti[idx];
                let prevClass = [...classiAmmesse].reverse().find(c => c < valAttuale);
                if (prevClass !== undefined) frutti[idx] = prevClass;
            }
            currentScore = frutti.reduce((a, b) => a + b, 0);
            iter++;
        }

        let counts = {};
        classiFull.forEach(c => counts[c] = 0);
        frutti.forEach(x => counts[x]++);
        
        let dannoReale = currentScore / nFrutti;
        
        let html = `<table><tr><th>Cl.</th><th>N. Frutti</th><th>Prodotto</th></tr>`;
        classiFull.forEach(c => {
            let style = classiAmmesse.includes(c) ? "" : "color:#ccc;"; 
            let val = counts[c];
            let prod = val * c;
            html += `<tr style="${style}">
                <td>${c}</td>
                <td>${val > 0 ? val : '-'}</td>
                <td>${prod > 0 ? prod : '-'}</td>
            </tr>`;
        });
        
        // --- RIGA TOTALI (NUOVA) ---
        html += `<tr class="row-total">
            <td>TOT</td>
            <td>${nFrutti}</td>
            <td>${currentScore}</td>
        </tr>`;
        
        html += `</table>`;
        html += `<div class="total-box">Media: ${dannoReale.toFixed(2)}%</div>`;
        
        if (Math.abs(dannoReale - targetPerc) > 1.0) {
            html += `<div class="warning-box">‚ö†Ô∏è Target irraggiungibile (Max: ${dannoReale.toFixed(2)}%)</div>`;
        }

        document.getElementById(elementId).innerHTML = html;
    }
</script>

</body>
</html>
